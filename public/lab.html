<!doctype html>
<html lang="es" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <title>Resultados de Laboratorio — Descarga segura</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fuente moderna y legible -->
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Bootstrap 5.3 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <!-- Bootstrap Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    rel="stylesheet"
  />

  <!-- AOS Animations -->
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet" />

  <style>
    /* ======= Paleta elegante, suave y accesible ======= */
    :root{
      /* Base */
      --bg:#f7f9fb;               /* fondo muy suave */
      --bg-card: rgba(255,255,255,.88); /* glass */
      --line:#e6edf5;             /* líneas sutiles */
      --txt:#1f2a37;              /* gris petróleo */
      --muted:#6b7b8d;            /* gris elegante */

      /* Marca (indigo ➜ cian) */
      --brand:#3b82f6;            /* Indigo 500 */
      --brand-2:#06b6d4;          /* Cian 500 */

      /* Estado */
      --ok:#16a34a;               /* verde */
      --err:#dc2626;              /* rojo */

      /* Sombras y decoraciones */
      --shadow-lg: 0 20px 50px rgba(20, 50, 90, .12);
      --shadow-md: 0 10px 30px rgba(20, 50, 90, .10);
      --grad-bg: radial-gradient(1000px 600px at 10% -10%, rgba(59,130,246,.12), transparent 60%),
                 radial-gradient(1000px 600px at 100% 0%, rgba(6,182,212,.10), transparent 55%);
      --pattern:
        radial-gradient(circle at 20px 20px, rgba(59,130,246,.06) 2px, transparent 2px),
        radial-gradient(circle at 60px 60px, rgba(6,182,212,.06) 2px, transparent 2px);
    }

    html,body{ height:100%; }
    body{ background: var(--bg); color: var(--txt); font-family: "Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }

    .page-wrap{
      min-height:100dvh; display:grid; align-items:center; padding:28px;
      background-image: var(--grad-bg), var(--pattern);
      background-size: auto, 80px 80px;
    }

    /* Chip superior */
    .brand-chip{
      display:inline-flex; align-items:center; gap:.5rem;
      background: linear-gradient(90deg, rgba(59,130,246,.12), rgba(6,182,212,.12));
      color:#0f3a63; border:1px solid #d9e6f5; padding:.55rem .9rem; border-radius:999px;
      backdrop-filter: blur(6px);
    }

    /* Card estilo glass */
    .card-lab{
      border-radius: 20px; background: var(--bg-card);
      border: 1px solid var(--line); box-shadow: var(--shadow-lg);
      backdrop-filter: blur(10px);
    }

    .hero-head{ display:flex; gap:1rem; align-items:center; }

    .brand-img{
      width:58px; height:58px; border-radius:16px; display:grid; place-items:center;
      border: 1px solid var(--line); background: linear-gradient(135deg, #eef4ff, #ecfeff);
      box-shadow: var(--shadow-md);
    }

    .lead-sm{ color: var(--muted); }

    .badge-lite{
      background:linear-gradient(180deg, #f0f6ff, #eefbff);
      border:1px solid #dce8f6; color:#0f4c81; font-weight:600;
    }

    .form-control,.form-select{
      background:#fbfdff; border-color:#d8e5f2; color: var(--txt);
      border-radius: 14px; padding:.7rem .9rem; transition: box-shadow .2s ease, border-color .2s ease;
    }
    .form-control:focus,.form-select:focus{
      border-color: var(--brand);
      box-shadow: 0 0 0 .25rem rgba(59,130,246,.18);
    }
    .input-group-text{ background:#f3f8ff; border-color:#d8e5f2; color:#245d99; border-radius:14px; }

    .btn-brand{
      background: linear-gradient(90deg, var(--brand) 0%, var(--brand-2) 100%);
      border: none; color:#ffffff; font-weight:800; border-radius: 14px; letter-spacing:.2px;
      box-shadow: 0 10px 24px rgba(59,130,246,.25);
      transition: transform .06s ease, filter .15s ease, box-shadow .15s ease;
    }
    .btn-brand:hover{ filter: brightness(1.06); box-shadow: 0 14px 28px rgba(59,130,246,.28); }
    .btn-brand:active{ transform: translateY(1px); }
    .btn-brand:disabled{ opacity:.75; box-shadow:none; }

    .toggle-link{ cursor:pointer; user-select:none; color:#0f74c5; font-weight:600; }
    .toggle-link:hover{ text-decoration: underline; }

    .help-row{ border-top:1px dashed #e4eff8; color: var(--muted); }
    .privacy{ font-size:.95rem; color: var(--muted); }
    .text-success-soft{ color: var(--ok); }
    .text-danger-soft{ color: var(--err); }

    /* Micro-interacciones */
    .form-label{ font-weight:700; }
    .badge{ border-radius: 999px; }
  </style>
</head>
<body>
  <div class="page-wrap container">
    <div class="row justify-content-center w-100">
      <div class="col-12 col-lg-8 col-xl-6" data-aos="fade-up" data-aos-duration="700" data-aos-easing="ease-out-quart">

        <!-- Encabezado -->
        <div class="text-center mb-3">
          <span class="brand-chip">
            <i class="bi bi-flask"></i>
            <span>Laboratorio Clínico · Descarga de resultados</span>
          </span>
        </div>

        <div class="card card-lab p-4 p-md-5">
          <div class="hero-head mb-3">
            <div class="brand-img">
              <i class="bi bi-shield-lock" style="color:#0a72bb;font-size:1.15rem"></i>
            </div>
            <div>
              <h1 class="h4 mb-1">Obtén tu resultado de laboratorio</h1>
              <p class="lead-sm mb-0">Verificamos tus datos y te entregamos el PDF de forma segura.</p>
            </div>
          </div>

          <!-- Confianza -->
          <div class="d-flex flex-wrap gap-2 mb-4">
            <span class="badge rounded-pill badge-lite"><i class="bi bi-shield-lock me-1"></i> Verificación segura</span>
            <span class="badge rounded-pill badge-lite"><i class="bi bi-file-earmark-pdf me-1"></i> PDF descargable</span>
            <span class="badge rounded-pill badge-lite"><i class="bi bi-clock me-1"></i> Proceso rápido</span>
          </div>

          <!-- Formulario -->
          <form id="formLab" class="needs-validation" novalidate>
            <div class="mb-3">
              <label for="numeroAdmision" class="form-label">Número de Admisión</label>
              <input id="numeroAdmision" type="text" class="form-control" placeholder="Ej: 163307" required />
              <div class="form-text">Lo encuentras en tu orden o recibo.</div>
              <div class="invalid-feedback">Ingrese el número de admisión.</div>
            </div>

            <div class="mb-2">
              <label for="tipoDocumento" class="form-label">Tipo de Documento</label>
              <select id="tipoDocumento" class="form-select" required></select>
              <div class="form-text">
                <span id="toggleTipos" class="toggle-link">mostrar más opciones</span>
              </div>
              <div class="invalid-feedback">Seleccione el tipo de documento.</div>
            </div>

            <div class="mb-3">
              <label for="numeroDocumento" class="form-label">Número de Documento</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-person-badge"></i></span>
                <input id="numeroDocumento" type="text" class="form-control" placeholder="Ej: 50993563" required />
              </div>
              <div class="invalid-feedback">Ingrese el número de documento.</div>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <label for="fechaEmision" class="form-label">Fecha de Emisión</label>
                <input id="fechaEmision" type="date" class="form-control" required />
                <div class="invalid-feedback">Seleccione la fecha de emisión.</div>
              </div>
              <div class="col-md-6">
                <label for="fechaNacimiento" class="form-label">Fecha de Nacimiento</label>
                <input id="fechaNacimiento" type="date" class="form-control" required />
                <div class="invalid-feedback">Seleccione la fecha de nacimiento.</div>
              </div>
            </div>

            <div class="d-grid mt-4">
              <button id="btnSubmit" type="submit" class="btn btn-brand py-3">
                <span class="btn-label">
                  <i class="bi bi-cloud-arrow-down-fill me-2"></i>
                  Descargar resultado
                </span>
                <span class="btn-working d-none">
                  <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  Procesando…
                </span>
              </button>
            </div>

            <div id="out" class="form-text mt-3" aria-live="polite"></div>
          </form>

          <!-- Ayuda -->
          <div class="help-row mt-4 pt-3">
            <div class="d-flex align-items-start gap-3">
              <div class="brand-img" style="width:46px;height:46px;border-radius:12px;">
                <i class="bi bi-info-circle" style="color:#0a72bb"></i>
              </div>
              <div>
                <strong>¿Necesitas ayuda?</strong>
                <div class="small text-body-secondary">
                  Verifica que el número de admisión, tipo y número de documento, y las fechas sean correctas.
                  Por seguridad, solo permitimos la descarga cuando la verificación es exitosa.
                  <br />Soporte: <a href="mailto:soporte@laboratorio.com" class="link-primary">soporte@laboratorio.com</a>
                </div>
              </div>
            </div>
          </div>

          <!-- Privacidad -->
          <div class="privacy mt-3">
            <i class="bi bi-shield-check me-1"></i> Usamos tus datos únicamente para validar tu identidad y permitir la descarga del PDF.
          </div>
        </div>
      </div>
    </div>

    <!-- Toasts -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
      <div id="toastOk" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body"><i class="bi bi-check2-circle me-2"></i><span class="txt">Listo</span></div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
        </div>
      </div>
      <div id="toastErr" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body"><i class="bi bi-x-circle me-2"></i><span class="txt">Error</span></div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
        </div>
      </div>
      <div id="toastInfo" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="polite" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body"><i class="bi bi-info-circle me-2"></i><span class="txt">Procesando…</span></div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>
  <!-- AOS JS -->
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>

  <script>
    AOS.init();
    // === CONFIGURACIÓN (ajusta a tu entorno) ===
    const BASE_URL = "https://total-oeyx.onrender.com";
    const INSTITUCION_ID = 20;
    const USER_ID = 6874; // el backend espera 'idUser'
    // ===========================================

    // ---------- Helpers UI ----------
    const $ = (sel, root=document) => root.querySelector(sel);
    const form = $("#formLab");

    function setWorking(working) {
      const btn = $("#btnSubmit");
      btn.disabled = working;
      $(".btn-label", btn).classList.toggle("d-none", working);
      $(".btn-working", btn).classList.toggle("d-none", !working);
    }
    function showToast(kind, text) {
      const node = { ok: $("#toastOk"), err: $("#toastErr"), info: $("#toastInfo") }[kind];
      if (!node) return;
      $(".txt", node).textContent = text;
      new bootstrap.Toast(node, { delay: kind === "err" ? 4200 : 2300 }).show();
    }
    function msg(text, ok = true) {
      $("#out").innerHTML = (ok
        ? `<span class="text-success-soft"><i class="bi bi-check2-circle me-1"></i>${text}</span>`
        : `<span class="text-danger-soft"><i class="bi bi-x-circle me-1"></i>${text}</span>`
      );
    }

    // ---------- Listas de documento ----------
    const TIPOS_ALL = [
      { code: "AS", label: "Adulto sin identificación (a confirmar)" },
      { code: "CC", label: "Cédula de Ciudadanía" },
      { code: "CD", label: "Carné Diplomático" },
      { code: "CE", label: "Cédula de Extranjería" },
      { code: "CN", label: "Certificado Nacido Vivo" },
      { code: "DE", label: "Documento Extranjero" },
      { code: "NV", label: "Nacido Vivo (similar a CN)" },
      { code: "PA", label: "Pasaporte" },
      { code: "PE", label: "Permiso Especial" },
      { code: "PEP", label: "Permiso Especial de Permanencia" },
      { code: "PT", label: "Permiso Temporal" },
      { code: "RC", label: "Registro Civil" },
      { code: "SC", label: "Salvoconducto" },
      { code: "TI", label: "Tarjeta de Identidad" },
    ];
    const TIPOS_COMUNES = ["CC", "TI", "RC", "PE"];

    const selTipo = $("#tipoDocumento");
    const toggle = $("#toggleTipos");
    let mostrandoTodos = false;

    function renderTipos(showAll = false) {
      const list = showAll ? TIPOS_ALL : TIPOS_ALL.filter(t => TIPOS_COMUNES.includes(t.code));
      selTipo.innerHTML = "";
      list.forEach(t => {
        const op = document.createElement("option");
        op.value = t.code;
        op.textContent = `${t.code} — ${t.label}`;
        selTipo.appendChild(op);
      });
      selTipo.value = "CC";
    }
    toggle.addEventListener("click", () => {
      mostrandoTodos = !mostrandoTodos;
      renderTipos(mostrandoTodos);
      toggle.textContent = mostrandoTodos ? "mostrar opciones comunes" : "mostrar más opciones";
    });
    renderTipos(false);

    // ---------- Utilidades ----------
    function camposCompletos() {
      return (
        $("#numeroAdmision").value.trim() &&
        selTipo.value.trim() &&
        $("#numeroDocumento").value.trim() &&
        $("#fechaEmision").value &&
        $("#fechaNacimiento").value
      );
    }
    function buildParams({ numeroAdmision, tipoDocumento, numeroDocumento, fechaEmision, fechaNacimiento, mode = "json" }) {
      const params = new URLSearchParams({
        institucionId: String(INSTITUCION_ID),
        idUser: String(USER_ID),
        numeroAdmision: String(numeroAdmision),
        tipoDocumento: String(tipoDocumento).toUpperCase(),
        numeroDocumento: String(numeroDocumento),
        fechaEmision,     // YYYY-MM-DD
        fechaNacimiento,  // YYYY-MM-DD
        mode
      });
      return params.toString();
    }

    async function validateDatos(payload) {
      const url = `${BASE_URL}/laboratorio?${buildParams({ ...payload, mode: "json" })}`;
      const r = await fetch(url, { method: "POST" });

      if (!r.ok) {
        let errMsg = "Sus datos no coinciden, verifique bien.";
        try {
          const data = await r.json();
          if (data?.error) errMsg = data.error;
        } catch (_) {}
        throw new Error(errMsg);
      }

      const data = await r.json();

      if (data?.success !== true || !data?.url) {
        throw new Error(data?.error || "Datos no válidos o no se recibió URL de reporte.");
      }
      if (data?.tipoDocumento && data.tipoDocumento !== payload.tipoDocumento) {
        throw new Error("El tipo de documento no coincide.");
      }
      if (data?.numeroDocumento && String(data.numeroDocumento) !== String(payload.numeroDocumento)) {
        throw new Error("El número de documento no coincide.");
      }
      return data; // incluye .url y metadatos
    }

    async function descargarPDF(payload, sugeridoFilename = "Resultado_Laboratorio.pdf") {
      const streamUrl = `${BASE_URL}/laboratorio?${buildParams({ ...payload, mode: "stream" })}`;
      const r = await fetch(streamUrl, {
        method: "POST",
        headers: { "Accept": "application/pdf" }
      });

      const contentType = r.headers.get("Content-Type") || "";
      const blob = await r.blob();
      const esPDF = contentType.includes("application/pdf") || blob.type === "application/pdf";
      const tamanoOk = blob.size > 5 * 1024;

      if (!r.ok || !esPDF || !tamanoOk) {
        throw new Error("No se pudo descargar el PDF (verifique los datos).");
      }

      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = sugeridoFilename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // ---------- Submit ----------
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!form.checkValidity() || !camposCompletos()) {
        form.classList.add("was-validated");
        msg("Debe completar todos los campos obligatorios.", false);
        showToast("err", "Complete los campos obligatorios.");
        return;
      }

      const payload = {
        numeroAdmision:  $("#numeroAdmision").value.trim(),
        tipoDocumento:   selTipo.value.trim().toUpperCase(),
        numeroDocumento: $("#numeroDocumento").value.trim(),
        fechaEmision:    $("#fechaEmision").value,
        fechaNacimiento: $("#fechaNacimiento").value
      };

      setWorking(true);
      msg("Verificando datos…");
      showToast("info", "Verificando datos…");

      try {
        const data = await validateDatos(payload); // Solo continúa si coincide

        msg("Descargando reporte…");
        showToast("info", "Descargando reporte…");
        const filename = `Resultado_Laboratorio_${payload.numeroAdmision}.pdf`;

        await descargarPDF(payload, filename);

        msg("Descarga completada.", true);
        showToast("ok", "Descarga completada.");
      } catch (err) {
        msg(err.message || "Sus datos no coinciden, verifique bien.", false);
        showToast("err", err.message || "Sus datos no coinciden.");
      } finally {
        setWorking(false);
      }
    });
  </script>
</body>
</html>
