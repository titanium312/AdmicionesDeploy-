<!doctype html>
<html lang="es" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <title>Resultados de Laboratorio — Descarga segura</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet" />
  <style>
    :root {
      --bg:#0b1220; --bg-card:rgba(255,255,255,.92); --line:#dfe8f3;
      --txt:#0f172a; --muted:#66768b; --brand:#2563eb; --brand-2:#06b6d4;
      --ok:#16a34a; --err:#dc2626;
      --shadow-lg:0 24px 60px rgba(9,21,46,.22);
      --shadow-md:0 12px 28px rgba(9,21,46,.15);
    }

    html, body { height: 100%; }
    body {
      background: var(--bg);
      color: var(--txt);
      font-family: "Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
    }

    .page-wrap {
      position: relative;
      min-height: 100svh;
      display: grid;
      place-items: center;
      padding: clamp(16px, 3vw, 40px);
      isolation: isolate;
      overflow: hidden;
    }
    .page-wrap::before {
      content: "";
      position: absolute; inset: 0;
      background: url("./fondo.jpg") center center / cover no-repeat fixed;
      z-index: -2;
      transform: scale(1.02);
    }
    .page-wrap::after {
      content: "";
      position: absolute; inset: 0;
      background: radial-gradient(1200px 600px at 70% -10%, rgba(37,99,235,.28), transparent 60%),
                  radial-gradient(1000px 500px at -10% 100%, rgba(6,182,212,.26), transparent 50%),
                  linear-gradient(180deg, rgba(2,6,23,.35), rgba(2,6,23,.45));
      z-index: -1;
    }

    .card-shell {
      width: min(100%, 780px);
      margin-inline: auto;
    }
    .card-lab {
      border-radius: 22px;
      background: var(--bg-card);
      border: 1px solid var(--line);
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(10px) saturate(1.08);
    }

    .brand-chip{display:inline-flex;align-items:center;gap:.5rem;background:linear-gradient(90deg,rgba(59,130,246,.12),rgba(6,182,212,.12));color:#0f3a63;border:1px solid #d9e6f5;padding:.55rem .9rem;border-radius:999px;backdrop-filter:blur(6px)}
    .hero-head{display:flex;gap:1rem;align-items:center;justify-content:center;flex-wrap:wrap;text-align:center}
    .brand-img{width:165px;height:165px;border-radius:22px;display:grid;place-items:center;border:1px solid var(--line);background:linear-gradient(135deg,#eef4ff,#ecfeff);box-shadow:var(--shadow-md);padding:10px}
    .brand-img img{width:100%;height:100%;object-fit:contain;border-radius:18px;filter:drop-shadow(0 6px 8px rgba(0,0,0,.3))}

    .lead-sm{color:var(--muted)}
    .badge-lite{background:linear-gradient(180deg,#f0f6ff,#eefbff);border:1px solid #dce8f6;color:#0f4c81;font-weight:600}

    .form-control,.form-select{background:#fbfdff;border-color:#d8e5f2;color:var(--txt);border-radius:14px;padding:.8rem 1rem;transition:box-shadow .2s ease,border-color .2s ease}
    .form-control:focus,.form-select:focus{border-color:var(--brand);box-shadow:0 0 0 .25rem rgba(37,99,235,.18)}
    .input-group-text{background:#f3f8ff;border-color:#d8e5f2;color:#245d99;border-radius:14px}

    .btn-brand{background:linear-gradient(90deg,var(--brand) 0%,var(--brand-2) 100%);border:none;color:#fff;font-weight:800;border-radius:14px;box-shadow:0 10px 24px rgba(37,99,235,.25);transition:transform .06s ease,filter .15s ease,box-shadow .15s ease}
    .btn-brand:hover{filter:brightness(1.06);box-shadow:0 14px 28px rgba(37,99,235,.28)}
    .btn-brand:active{transform:translateY(1px)}
    .btn-brand:disabled{opacity:.75;box-shadow:none}

    .toggle-link{cursor:pointer;color:#0f74c5;font-weight:600}
    .help-row{border-top:1px dashed #e4eff8;color:var(--muted)}
    .privacy{font-size:.95rem;color:var(--muted)}
    .text-success-soft{color:var(--ok)}
    .text-danger-soft{color:var(--err)}

    @media (max-width: 576px){
      .brand-img{width:140px;height:140px}
    }
  </style>
</head>
<body>
  <main class="page-wrap">
    <div class="card-shell">
      <div class="card card-lab p-4 p-md-5" data-aos="fade-up" data-aos-duration="700">
        <div class="hero-head mb-3">
          <div class="brand-img">
            <img src="/lab/logo.png" alt="Logo del hospital">
          </div>
          <div>
            <h1 class="h4 mb-1">Obtén tu resultado de laboratorio</h1>
            <p class="lead-sm mb-0">Verificamos tus datos y te entregamos el PDF de forma segura.</p>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2 justify-content-center mb-4">
          <span class="badge rounded-pill badge-lite"><i class="bi bi-shield-lock me-1"></i> Verificación segura</span>
          <span class="badge rounded-pill badge-lite"><i class="bi bi-file-earmark-pdf me-1"></i> PDF descargable</span>
          <span class="badge rounded-pill badge-lite"><i class="bi bi-clock me-1"></i> Proceso rápido</span>
        </div>

        <form id="formLab" class="needs-validation" novalidate>
          <div class="mb-3">
            <label for="numeroAdmision" class="form-label">Número de Admisión</label>
            <input id="numeroAdmision" type="text" inputmode="numeric" class="form-control" placeholder="Ej: 163307" required />
            <div class="form-text">Lo encuentras en tu orden o recibo.</div>
            <div class="invalid-feedback">Ingrese el número de admisión.</div>
          </div>

          <div class="mb-2">
            <label for="tipoDocumento" class="form-label">Tipo de Documento</label>
            <select id="tipoDocumento" class="form-select" required></select>
            <div class="form-text"><span id="toggleTipos" class="toggle-link">mostrar más opciones</span></div>
            <div class="invalid-feedback">Seleccione el tipo de documento.</div>
          </div>

          <div class="mb-3">
            <label for="numeroDocumento" class="form-label">Número de Documento</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-person-badge"></i></span>
              <input id="numeroDocumento" type="text" inputmode="numeric" class="form-control" placeholder="Ej: 50993563" required />
            </div>
            <div class="invalid-feedback">Ingrese el número de documento.</div>
          </div>

          <div class="row g-3">
            <div class="col-md-6 mx-auto">
              <label for="fechaNacimiento" class="form-label">Fecha de Nacimiento</label>
              <input id="fechaNacimiento" type="date" class="form-control" required />
              <div class="invalid-feedback">Seleccione la fecha de nacimiento.</div>
            </div>
          </div>

          <div class="d-grid mt-4">
            <button id="btnSubmit" type="submit" class="btn btn-brand py-3">
              <span class="btn-label"><i class="bi bi-cloud-arrow-down-fill me-2"></i>Descargar resultado</span>
              <span class="btn-working d-none"><span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Procesando…</span>
            </button>
          </div>

          <div id="out" class="form-text mt-3 text-center" aria-live="polite"></div>
        </form>

        <div class="help-row mt-4 pt-3">
          <div class="d-flex align-items-start gap-3 justify-content-center">
            <div class="brand-img" style="width:46px;height:46px;border-radius:12px;">
              <i class="bi bi-info-circle" style="color:#0a72bb"></i>
            </div>
            <div>
              <strong>¿Necesitas ayuda?</strong>
              <div class="small text-body-secondary">
                Verifica que el número de admisión, tipo y número de documento, y la fecha de nacimiento sean correctos.<br />
                Soporte: <a href="mailto:soporte@laboratorio.com" class="link-light text-decoration-underline">soporte@laboratorio.com</a>
              </div>
            </div>
          </div>
        </div>

        <div class="privacy mt-3 text-center">
          <i class="bi bi-shield-check me-1"></i> Usamos tus datos únicamente para validar tu identidad y permitir la descarga del PDF.
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script>
    AOS.init();
    const BASE_URL = "https://total-oeyx.onrender.com";
    const ROUTE_PATH = "/DescargarLaboratorio";
    const INSTITUCION_ID = 20;
    const USER_ID = 6874;
    const $ = (s,r=document)=>r.querySelector(s);
    const form=$('#formLab');

    function setWorking(w){
      const b=$('#btnSubmit');
      b.disabled=w;
      $('.btn-label',b).classList.toggle('d-none',w);
      $('.btn-working',b).classList.toggle('d-none',!w)
    }
    function msg(t,o=true){
      $('#out').innerHTML=o?`<span class='text-success-soft'><i class='bi bi-check2-circle me-1'></i>${t}</span>`:`<span class='text-danger-soft'><i class='bi bi-x-circle me-1'></i>${t}</span>`
    }

    const TIPOS_ALL=[
      {code:'AS',label:'Adulto sin identificación'},
      {code:'CC',label:'Cédula de Ciudadanía'},
      {code:'CE',label:'Cédula de Extranjería'},
      {code:'TI',label:'Tarjeta de Identidad'},
      {code:'RC',label:'Registro Civil'},
      {code:'PA',label:'Pasaporte'},
      {code:'PE',label:'Permiso Especial'},
      {code:'PEP',label:'Permiso Especial de Permanencia'}
    ];
    const TIPOS_COMUNES=['CC','TI','RC','PE'];
    const selTipo=$('#tipoDocumento');
    const toggle=$('#toggleTipos');
    let showAll=false;

    function renderTipos(a=false){
      const l=a?TIPOS_ALL:TIPOS_ALL.filter(t=>TIPOS_COMUNES.includes(t.code));
      selTipo.innerHTML='';
      l.forEach(t=>{
        const o=document.createElement('option');
        o.value=t.code;
        o.textContent=`${t.code} — ${t.label}`;
        selTipo.appendChild(o)
      });
      selTipo.value='CC'
    }

    toggle.addEventListener('click',()=>{
      showAll=!showAll;
      renderTipos(showAll);
      toggle.textContent=showAll?'mostrar opciones comunes':'mostrar más opciones'
    });
    renderTipos(false);

    function onlyDigits(v){return(v||'').replace(/\D+/g,'')}
    function camposCompletos(){
      return $('#numeroAdmision').value.trim()&&selTipo.value.trim()&&$('#numeroDocumento').value.trim()&&$('#fechaNacimiento').value
    }

    function buildParams({numeroAdmision,tipoDocumento,numeroDocumento,fechaNacimiento,mode='json'}){
      return new URLSearchParams({
        institucionId:String(INSTITUCION_ID),
        idUser:String(USER_ID),
        numeroAdmision:String(numeroAdmision),
        tipoDocumento:String(tipoDocumento).toUpperCase(),
        numeroDocumento:String(numeroDocumento),
        fechaNacimiento,
        mode
      }).toString()
    }

    async function validateDatos(p){
      const u=`${BASE_URL}${ROUTE_PATH}?${buildParams({...p,mode:'json'})}`;
      const r=await fetch(u,{method:'POST'});
      if(!r.ok)throw new Error('Error validando datos');
      const d=await r.json();
      if(!d?.success||!d?.url)throw new Error('Datos no válidos');
      return d
    }

    async function descargarPDF(p,f='Resultado_Laboratorio.pdf'){
      const u=`${BASE_URL}${ROUTE_PATH}?${buildParams({...p,mode:'stream'})}`;
      const r=await fetch(u,{method:'POST',headers:{Accept:'application/pdf'}});
      const ct=r.headers.get('Content-Type')||'';
      const b=await r.blob();
      if(!r.ok||!ct.includes('application/pdf')||b.size<5*1024)throw new Error('No se pudo descargar el PDF');
      const a=document.createElement('a');
      a.href=URL.createObjectURL(b);
      a.download=f;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a)
    }

    form.addEventListener('submit',async e=>{
      e.preventDefault();
      if(!form.checkValidity()||!camposCompletos()){
        form.classList.add('was-validated');
        msg('Debe completar los campos obligatorios.',false);
        return
      }
      const p={
        numeroAdmision:onlyDigits($('#numeroAdmision').value.trim()),
        tipoDocumento:selTipo.value.trim().toUpperCase(),
        numeroDocumento:onlyDigits($('#numeroDocumento').value.trim()),
        fechaNacimiento:$('#fechaNacimiento').value
      };
      setWorking(true);
      msg('Verificando datos…');
      try{
        await validateDatos(p);
        msg('Descargando reporte…');
        await descargarPDF(p,`Resultado_Laboratorio_${p.numeroAdmision}.pdf`);
        msg('Descarga completada.',true)
      }catch(err){
        msg(err.message||'Error en la descarga',false)
      }finally{
        setWorking(false)
      }
    });
  </script>
</body>
</html>
