<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Numeración de Facturas</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <!-- Custom CSS -->
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #7209b7;
      --success: #06d6a0;
      --danger: #ef476f;
      --warning: #ffd166;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --border-radius: 12px;
      --box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
      min-height: 100vh;
      padding: 20px 0;
    }

    .gradient-header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border-radius: var(--border-radius);
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--box-shadow);
    }

    .card-custom {
      border: none;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      transition: var(--transition);
      margin-bottom: 1.5rem;
    }

    .card-custom:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
    }

    .btn-primary-custom {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border: none;
      border-radius: var(--border-radius);
      padding: 12px 30px;
      font-weight: 600;
      transition: var(--transition);
      box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
    }

    .btn-primary-custom:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
    }

    .result-card {
      border-left: 4px solid;
      transition: var(--transition);
    }

    .result-card:hover {
      transform: translateY(-3px);
    }

    .result-success {
      border-left-color: var(--success);
    }

    .result-error {
      border-left-color: var(--danger);
    }

    .icon-lg {
      font-size: 1.5rem;
    }

    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .empty-state {
      padding: 3rem 1rem;
      text-align: center;
      color: var(--gray);
    }

    .progress-custom {
      height: 8px;
      border-radius: 10px;
    }

    .floating-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 100;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .badge-custom {
      font-size: 0.8rem;
      padding: 0.5rem 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="gradient-header text-center animate__animated animate__fadeInDown">
      <h1 class="display-4 fw-bold mb-3"><i class="fas fa-file-invoice-dollar me-3"></i>Sistema de Numeración de Facturas</h1>
      <p class="lead mb-0">Genera números de factura para múltiples admisiones de forma rápida y eficiente</p>
    </div>

    <div class="row">
      <!-- Form Section -->
      <div class="col-lg-6">
        <div class="card card-custom animate__animated animate__fadeInLeft">
          <div class="card-header bg-white">
            <h3 class="card-title mb-0"><i class="fas fa-cogs text-primary me-2"></i>Configuración</h3>
          </div>
          <div class="card-body">
            <div class="alert alert-info">
              <h5><i class="fas fa-info-circle me-2"></i>Instrucciones</h5>
              <ul class="mb-0">
                <li>Ingresa el ID de la institución (por defecto es 20)</li>
                <li>Proporciona los números de admisión, uno por línea o separados por comas</li>
                <li>Haz clic en "Procesar lista" para generar los números de factura</li>
              </ul>
            </div>

            <div class="mb-3">
              <label for="institucion" class="form-label fw-semibold"><i class="fas fa-building me-2"></i>ID de Institución</label>
              <input type="number" class="form-control form-control-lg" value="20" id="institucion" placeholder="Ej: 20">
            </div>

            <div class="mb-4">
              <label for="admisiones" class="form-label fw-semibold"><i class="fas fa-list-ol me-2"></i>Lista de Números de Admisión</label>
              <textarea class="form-control" id="admisiones" rows="6" placeholder="Ejemplo: 51629, 51630, 51631"></textarea>
              <div class="form-text">Puedes ingresar números separados por comas o por líneas.</div>
            </div>

            <div class="d-grid">
              <button id="btn" class="btn btn-primary-custom btn-lg">
                <i class="fas fa-cogs me-2"></i> Procesar lista
              </button>
            </div>

            <!-- Progress Bar -->
            <div class="mt-4 d-none" id="progressContainer">
              <div class="d-flex justify-content-between mb-2">
                <span>Progreso</span>
                <span id="progressText">0%</span>
              </div>
              <div class="progress progress-custom">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Stats Card -->
        <div class="card card-custom stats-card animate__animated animate__fadeInUp">
          <div class="card-body text-center">
            <h4 class="card-title mb-3"><i class="fas fa-chart-bar me-2"></i>Estadísticas</h4>
            <div class="row">
              <div class="col-4">
                <h2 id="totalCount" class="fw-bold">0</h2>
                <small>Total</small>
              </div>
              <div class="col-4">
                <h2 id="successCount" class="fw-bold text-success">0</h2>
                <small>Éxitos</small>
              </div>
              <div class="col-4">
                <h2 id="errorCount" class="fw-bold text-danger">0</h2>
                <small>Errores</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div class="col-lg-6">
        <div class="card card-custom animate__animated animate__fadeInRight">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0"><i class="fas fa-clipboard-list text-primary me-2"></i>Resultados</h3>
            <span class="badge bg-primary badge-custom" id="resultsCount">0 procesados</span>
          </div>
          <div class="card-body p-0">
            <div id="resultsContainer" style="max-height: 600px; overflow-y: auto;">
              <div id="listaResultados" class="p-3">
                <!-- Results will be inserted here -->
              </div>
            </div>
            
            <!-- Empty State -->
            <div id="emptyState" class="empty-state">
              <i class="fas fa-file-invoice fa-4x mb-3 text-muted"></i>
              <h4 class="text-muted">No hay resultados aún</h4>
              <p class="text-muted">Los resultados de las admisiones procesadas aparecerán aquí</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Action Button -->
  <button class="btn btn-primary btn-lg rounded-circle floating-btn pulse d-none" id="scrollTopBtn">
    <i class="fas fa-arrow-up"></i>
  </button>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const btn = document.getElementById("btn");
      const lista = document.getElementById("listaResultados");
      const resultsContainer = document.getElementById("resultsContainer");
      const emptyState = document.getElementById("emptyState");
      const resultsCount = document.getElementById("resultsCount");
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");
      const scrollTopBtn = document.getElementById("scrollTopBtn");
      const totalCountEl = document.getElementById("totalCount");
      const successCountEl = document.getElementById("successCount");
      const errorCountEl = document.getElementById("errorCount");

      let totalCount = 0;
      let successCount = 0;
      let errorCount = 0;

      // Scroll to top button
      scrollTopBtn.addEventListener('click', function() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
          scrollTopBtn.classList.remove('d-none');
        } else {
          scrollTopBtn.classList.add('d-none');
        }
      });

      btn.addEventListener("click", async () => {
        const institucionId = document.getElementById("institucion").value.trim();
        const admisionesInput = document.getElementById("admisiones").value.trim();

        if (!institucionId || !admisionesInput) {
          Swal.fire({
            icon: 'warning',
            title: 'Datos incompletos',
            text: 'Debes ingresar el ID de institución y al menos un número de admisión.',
            confirmButtonColor: '#4361ee'
          });
          return;
        }

        // Convertir lista (separada por comas o saltos de línea) en array limpio
        const admisiones = admisionesInput
          .split(/[\s,]+/)
          .map(a => a.trim())
          .filter(a => a !== '');

        if (admisiones.length === 0) {
          Swal.fire({
            icon: 'warning',
            title: 'Lista vacía',
            text: 'La lista de admisiones está vacía.',
            confirmButtonColor: '#4361ee'
          });
          return;
        }

        // Mostrar confirmación
        const result = await Swal.fire({
          title: '¿Procesar admisiones?',
          html: `Se procesarán <strong>${admisiones.length}</strong> números de admisión.`,
          icon: 'question',
          showCancelButton: true,
          confirmButtonColor: '#4361ee',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Sí, procesar',
          cancelButtonText: 'Cancelar'
        });

        if (!result.isConfirmed) return;

        // Preparar interfaz para procesamiento
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Procesando...';
        lista.innerHTML = '';
        emptyState.classList.add('d-none');
        progressContainer.classList.remove('d-none');
        
        // Reset counters
        totalCount = admisiones.length;
        successCount = 0;
        errorCount = 0;
        updateCounters();

        for (let i = 0; i < admisiones.length; i++) {
          const numeroAdmision = admisiones[i];
          
          // Update progress
          const progress = Math.round((i / admisiones.length) * 100);
          progressBar.style.width = `${progress}%`;
          progressText.textContent = `${progress}%`;
          
          try {
            // Simular llamada a la API (reemplazar con tu endpoint real)
            const url = `http://localhost:3000/por-admision?institucionId=${institucionId}&numeroAdmision=${numeroAdmision}`;
            const res = await fetch(url);
            const data = await res.json();

            console.log(`Respuesta (${numeroAdmision}):`, data);

            const item = document.createElement("div");
            item.className = "card result-card mb-3 fade-in";
            
            if (data.ok) {
              item.classList.add("result-success");
              item.innerHTML = `
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-check-circle text-success icon-lg me-2"></i>
                    <h5 class="card-title mb-0 text-success">Factura Numerada</h5>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <p class="mb-1"><strong>Admisión:</strong> ${numeroAdmision}</p>
                      <p class="mb-1"><strong>ID Factura:</strong> ${data.id_factura}</p>
                    </div>
                    <div class="col-md-6">
                      <p class="mb-0"><strong>Número generado:</strong> <span class="badge bg-success">${data.resultado_remoto?.numeroFactura ?? 'N/A'}</span></p>
                    </div>
                  </div>
                </div>
              `;
              successCount++;
            } else {
              item.classList.add("result-error");
              item.innerHTML = `
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-exclamation-circle text-danger icon-lg me-2"></i>
                    <h5 class="card-title mb-0 text-danger">Error en Admisión</h5>
                  </div>
                  <p class="mb-1"><strong>Admisión:</strong> ${numeroAdmision}</p>
                  <p class="mb-0"><strong>Error:</strong> ${data.error || 'No se pudo procesar'}</p>
                </div>
              `;
              errorCount++;
            }
            
            lista.prepend(item);
          } catch (err) {
            console.error(err);
            const item = document.createElement("div");
            item.className = "card result-card result-error mb-3 fade-in";
            item.innerHTML = `
              <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                  <i class="fas fa-exclamation-triangle text-danger icon-lg me-2"></i>
                  <h5 class="card-title mb-0 text-danger">Error de Conexión</h5>
                </div>
                <p class="mb-1"><strong>Admisión:</strong> ${numeroAdmision}</p>
                <p class="mb-0"><strong>Error:</strong> ${err.message}</p>
              </div>
            `;
            lista.prepend(item);
            errorCount++;
          }
          
          // Update counters and progress
          updateCounters();
        }

        // Final progress update
        progressBar.style.width = `100%`;
        progressText.textContent = `100%`;

        // Restaurar botón
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-cogs me-2"></i> Procesar lista';

        // Show completion message
        Swal.fire({
          icon: successCount > errorCount ? 'success' : 'warning',
          title: 'Procesamiento completado',
          html: `Se procesaron <strong>${totalCount}</strong> admisiones:<br>
                 <span class="text-success">${successCount} éxitos</span> | 
                 <span class="text-danger">${errorCount} errores</span>`,
          confirmButtonColor: '#4361ee'
        });
      });

      function updateCounters() {
        totalCountEl.textContent = totalCount;
        successCountEl.textContent = successCount;
        errorCountEl.textContent = errorCount;
        resultsCount.textContent = `${successCount + errorCount} procesados`;
      }
    });
  </script>
</body>
</html>