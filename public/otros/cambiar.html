<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Generar factura / Cambiar fecha / Enviar a la DIAN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #050816;
      --bg-soft: #0f172a;
      --bg-softer: #111827;
      --primary: #3b82f6;
      --primary-soft: rgba(59, 130, 246, 0.15);
      --primary-strong: #2563eb;
      --accent: #22c55e;
      --danger: #ef4444;
      --warn: #facc15;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --radius-lg: 18px;
      --radius-md: 10px;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.75);
      --transition-fast: 0.18s ease-out;
      --transition-med: 0.25s ease-out;
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: var(--font-sans);
      background: radial-gradient(circle at top, #1d2540 0, #050816 40%, #020617 100%);
      color: var(--text);
      min-height: 100vh;
    }

    body {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 32px 16px;
    }

    .shell {
      width: 100%;
      max-width: 1100px;
    }

    .title {
      margin-bottom: 18px;
    }

    .title h1 {
      font-size: clamp(1.6rem, 2.2vw, 2rem);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 0;
      color: #f9fafb;
    }

    .title h1 span.emoji {
      font-size: 1.8rem;
      filter: drop-shadow(0 0 6px rgba(251, 191, 36, 0.7));
    }

    .title-sub {
      color: var(--muted);
      font-size: 0.9rem;
      margin-top: 4px;
    }

    .card {
      background: radial-gradient(circle at top left, #111827 0, #020617 60%);
      border-radius: 24px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.15);
      overflow: hidden;
    }

    .card-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.16);
      background: linear-gradient(90deg, rgba(55, 65, 81, 0.4), rgba(15, 23, 42, 0.95));
    }

    .card-header-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .card-title {
      font-weight: 600;
      letter-spacing: 0.02em;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pill-env {
      font-size: 0.75rem;
      padding: 2px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.85);
      color: var(--muted);
    }

    .card-subtitle {
      font-size: 0.82rem;
      color: var(--muted);
    }

    .card-body {
      padding: 18px 20px 20px;
    }

    .muted {
      color: var(--muted);
      font-size: 0.85rem;
    }

    .hint {
      color: var(--muted);
      font-size: 0.8rem;
      margin-top: 6px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 14px 18px;
      align-items: flex-start;
    }

    .col-3 { grid-column: span 3; }
    .col-4 { grid-column: span 4; }
    .col-5 { grid-column: span 5; }
    .col-6 { grid-column: span 6; }
    .col-12 { grid-column: span 12; }

    @media (max-width: 900px) {
      .col-3, .col-4, .col-5, .col-6 { grid-column: span 12; }
    }

    label {
      display: block;
      font-size: 0.82rem;
      font-weight: 500;
      margin-bottom: 4px;
      color: #e5e7eb;
    }

    input[type="number"],
    input[type="date"],
    textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg-softer);
      color: var(--text);
      font: inherit;
      padding: 9px 10px;
      outline: none;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), transform 0.08s ease-out;
    }

    input[type="number"]:focus,
    input[type="date"]:focus,
    textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.5);
      background: #020617;
      transform: translateY(-1px);
    }

    input[disabled],
    textarea[disabled] {
      opacity: 0.7;
      cursor: not-allowed;
      background: #020617;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
      line-height: 1.4;
      font-size: 0.9rem;
      white-space: pre;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.95);
      cursor: pointer;
      font-size: 0.78rem;
      color: var(--muted);
      transition: border-color var(--transition-fast), background var(--transition-fast), transform 0.08s ease-out, box-shadow var(--transition-fast);
    }

    .chip input {
      accent-color: var(--primary);
      cursor: pointer;
    }

    .chip:hover {
      border-color: rgba(59, 130, 246, 0.9);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.4);
      transform: translateY(-1px);
    }

    .chip-active {
      border-color: var(--primary);
      background: radial-gradient(circle at top, rgba(37, 99, 235, 0.45), rgba(15, 23, 42, 0.98));
      color: #e5e7eb;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
    }

    .btn {
      border-radius: var(--radius-pill);
      border: none;
      padding: 8px 16px;
      font-size: 0.86rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background var(--transition-med), transform 0.08s ease-out, box-shadow var(--transition-med), opacity var(--transition-fast);
      outline: none;
      letter-spacing: 0.01em;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-strong));
      color: #eff6ff;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.55);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(37, 99, 235, 0.7);
    }

    .btn-secondary {
      background: rgba(31, 41, 55, 0.9);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .btn-secondary:hover {
      background: rgba(15, 23, 42, 1);
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.9);
    }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding-inline: 12px;
      font-size: 0.8rem;
    }

    .btn-ghost:hover {
      background: rgba(15, 23, 42, 0.8);
      color: #e5e7eb;
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
      gap: 10px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 0.76rem;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.8);
    }

    .status-dot-paused {
      background: var(--warn);
      box-shadow: 0 0 10px rgba(250, 204, 21, 0.9);
    }

    .status-dot-stopped {
      background: var(--danger);
      box-shadow: 0 0 10px rgba(248, 113, 113, 0.8);
    }

    .progress {
      width: 100%;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      border: 1px solid rgba(31, 41, 55, 0.95);
      overflow: hidden;
      height: 9px;
      position: relative;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--primary));
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.8);
      transition: width 0.18s ease-out;
      position: relative;
    }

    .progress-bar::after {
      content: "";
      position: absolute;
      inset: 0;
      background-image: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.3) 0,
        transparent 40%,
        transparent 60%,
        rgba(255, 255, 255, 0.3) 100%
      );
      background-size: 30px 30px;
      mix-blend-mode: soft-light;
      opacity: 0.7;
      animation: shimmer 1.1s linear infinite;
    }

    @keyframes shimmer {
      0% { background-position: -30px 0; }
      100% { background-position: 30px 0; }
    }

    .table-wrapper {
      margin-top: 18px;
      border-radius: 14px;
      border: 1px solid rgba(31, 41, 55, 0.95);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), #020617);
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    thead {
      background: linear-gradient(90deg, rgba(15, 23, 42, 0.95), rgba(30, 64, 175, 0.8));
    }

    th, td {
      padding: 7px 10px;
      text-align: left;
      border-bottom: 1px solid rgba(31, 41, 55, 0.95);
    }

    th {
      font-weight: 500;
      font-size: 0.78rem;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.85);
    }

    tbody tr:nth-child(odd) {
      background: rgba(2, 6, 23, 0.9);
    }

    tbody tr:hover {
      background: rgba(15, 23, 42, 1);
    }

    td {
      vertical-align: top;
    }

    td.col-msg {
      max-width: 320px;
      word-break: break-word;
      font-size: 0.78rem;
    }

    .tag {
      border-radius: 999px;
      padding: 2px 9px;
      font-size: 0.72rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }

    .tag-ok {
      background: rgba(34, 197, 94, 0.12);
      color: #bbf7d0;
      border: 1px solid rgba(34, 197, 94, 0.5);
    }

    .tag-error {
      background: rgba(239, 68, 68, 0.15);
      color: #fecaca;
      border: 1px solid rgba(248, 113, 113, 0.7);
    }

    .tag-info {
      background: rgba(59, 130, 246, 0.12);
      color: #bfdbfe;
      border: 1px solid rgba(59, 130, 246, 0.6);
    }

    .tag-warn {
      background: rgba(250, 204, 21, 0.14);
      color: #fef9c3;
      border: 1px solid rgba(250, 204, 21, 0.7);
    }

    .badge-small {
      font-size: 0.74rem;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--muted);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pill-count {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.78rem;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(31, 41, 55, 0.95);
      background: rgba(15, 23, 42, 0.9);
    }

    .pill-count span.num {
      font-weight: 600;
      color: #e5e7eb;
    }

    .pill-count span.total {
      color: var(--muted);
    }

    .footer-hint {
      margin-top: 10px;
      font-size: 0.78rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .footer-hint b {
      color: #e5e7eb;
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="title">
      <h1>
        <span class="emoji">üßæ</span>
        <span>Gesti√≥n de facturas por admisi√≥n</span>
      </h1>
      <div class="title-sub">
        Genera n√∫mero de factura, actualiza fecha de emisi√≥n y env√≠a a DIAN en lote, de forma autom√°tica.
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-header-left">
          <div class="card-title">
            Automatiza acciones por n√∫mero de admisi√≥n
            <span class="pill-env">API: https://total-oeyx.onrender.com</span>
          </div>
          <div class="card-subtitle">
            Procesa cada admisi√≥n en orden y guarda un historial detallado de cada paso.
          </div>
        </div>
        <button id="btnClear" class="btn btn-ghost" type="button">Limpiar todo</button>
      </div>

      <div class="card-body">
        <div class="grid">
          <div class="col-3">
            <label for="institucionId">Instituci√≥n ID</label>
            <input id="institucionId" type="number" min="1" value="20" />
            <div class="hint">Solo informativo, no se env√≠a a√∫n a la API.</div>
          </div>

          <div class="col-6">
            <label>¬øQu√© deseas hacer?</label>
            <div class="chips" role="group" aria-label="Opciones de proceso">
              <label class="chip chip-active">
                <input id="chkFactura" type="checkbox" checked />
                Generar n√∫mero de factura
              </label>
              <label class="chip">
                <input id="chkFecha" type="checkbox" />
                Cambiar fecha de emisi√≥n
              </label>
              <label class="chip">
                <input id="chkEnviar" type="checkbox" />
                Enviar a la DIAN
              </label>
            </div>
            <div class="hint">
              Siempre se buscar√° primero la factura por admisi√≥n.
              <br>
              Si marcas todo, el flujo ser√°:
              <b>Buscar factura ‚Üí Generar n√∫mero ‚Üí Cambiar fecha ‚Üí Enviar a DIAN</b>.
            </div>
          </div>

          <div class="col-3">
            <label for="fechaEmision">Fecha de emisi√≥n</label>
            <input id="fechaEmision" type="date" disabled />
            <div class="hint">
              Se requiere cuando marcas <b>Cambiar fecha de emisi√≥n</b>.
            </div>
          </div>

          <div class="col-12">
            <label for="admisiones">N√∫meros de admisi√≥n (uno por l√≠nea)</label>
            <textarea id="admisiones" placeholder="142811&#10;144140&#10;..."></textarea>
          </div>

          <div class="col-12">
            <div class="btn-row">
              <button id="btnStart" class="btn btn-primary" type="button">
                ‚ñ∂ Iniciar proceso
              </button>
              <button id="btnStop" class="btn btn-secondary" type="button" disabled>
                ‚è∏ Detener
              </button>
              <span class="muted">
                Procesa uno por uno y registra el resultado de cada acci√≥n en la tabla.
              </span>
            </div>
          </div>
        </div>

        <div class="status-bar">
          <div class="status-badge" id="statusBadge">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">En espera</span>
          </div>
          <div class="pill-count">
            <span class="num" id="lblProcessed">0</span>
            <span class="total" id="lblTotal">/ 0 procesadas</span>
          </div>
        </div>

        <div style="margin-top: 10px;">
          <div class="progress">
            <div class="progress-bar" id="bar"></div>
          </div>
        </div>

        <div class="table-wrapper">
          <table id="tbl">
            <thead>
              <tr>
                <th>Admisi√≥n</th>
                <th>Acci√≥n</th>
                <th>Estado</th>
                <th>Mensaje</th>
                <th>ID Factura</th>
                <th>Hora</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="footer-hint">
          <span>üß† Cada acci√≥n se maneja de forma independiente, si alguna falla se registra en el historial.</span>
          <span><b>Tip:</b> Usa el bot√≥n ‚ÄúLimpiar todo‚Äù antes de iniciar un nuevo lote grande.</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // ‚öôÔ∏è CONFIGURACI√ìN
    // ==========================
    const API_BASE = 'https://total-oeyx.onrender.com';

    // ==========================
    // üîó REFERENCIAS DOM
    // ==========================
    const institucionIdInput = document.getElementById('institucionId');
    const chkFactura = document.getElementById('chkFactura');
    const chkFecha = document.getElementById('chkFecha');
    const chkEnviar = document.getElementById('chkEnviar');
    const fechaEmisionInput = document.getElementById('fechaEmision');
    const admisionesInput = document.getElementById('admisiones');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const btnClear = document.getElementById('btnClear');
    const bar = document.getElementById('bar');
    const tblBody = document.querySelector('#tbl tbody');
    const statusBadge = document.getElementById('statusBadge');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const lblProcessed = document.getElementById('lblProcessed');
    const lblTotal = document.getElementById('lblTotal');

    let isRunning = false;
    let totalItems = 0;
    let processedItems = 0;

    // ==========================
    // üß© UTILIDADES
    // ==========================

    function todayAsInputValue() {
      const d = new Date();
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function formatDateForApi(yyyyMmDd) {
      if (!yyyyMmDd) return '';
      const [y, m, d] = yyyyMmDd.split('-');
      return `${d}/${m}/${y}`; // DD/MM/YYYY
    }

    function formatTime() {
      const d = new Date();
      return d.toLocaleTimeString('es-CO', { hour12: false });
    }

    function updateProgress(current, total) {
      const pct = total === 0 ? 0 : Math.round((current / total) * 100);
      bar.style.width = `${pct}%`;
      processedItems = current;
      lblProcessed.textContent = String(processedItems);
      lblTotal.textContent = `/ ${totalItems} procesadas`;
    }

    function setStatus(mode, text) {
      statusText.textContent = text;
      statusDot.classList.remove('status-dot-paused', 'status-dot-stopped');
      statusDot.classList.add('status-dot');

      if (mode === 'idle') {
        statusDot.style.background = 'var(--accent)';
        statusDot.style.boxShadow = '0 0 10px rgba(34,197,94,0.8)';
      } else if (mode === 'running') {
        statusDot.style.background = 'var(--accent)';
        statusDot.style.boxShadow = '0 0 10px rgba(34,197,94,0.8)';
      } else if (mode === 'stopped') {
        statusDot.style.background = 'var(--danger)';
        statusDot.style.boxShadow = '0 0 10px rgba(248,113,113,0.9)';
      } else if (mode === 'paused') {
        statusDot.style.background = 'var(--warn)';
        statusDot.style.boxShadow = '0 0 10px rgba(250,204,21,0.9)';
      }
    }

    function createTag(status) {
      const span = document.createElement('span');
      span.classList.add('tag');
      if (status === 'OK') {
        span.classList.add('tag-ok');
        span.textContent = 'OK';
      } else if (status === 'ERROR') {
        span.classList.add('tag-error');
        span.textContent = 'ERROR';
      } else if (status === 'WARN') {
        span.classList.add('tag-warn');
        span.textContent = 'AVISO';
      } else {
        span.classList.add('tag-info');
        span.textContent = status || 'INFO';
      }
      return span;
    }

    function logRow({ admision, accion, estado, mensaje, idFactura, hora }) {
      const tr = document.createElement('tr');

      const tdAdm = document.createElement('td');
      tdAdm.textContent = admision || '-';

      const tdAccion = document.createElement('td');
      tdAccion.textContent = accion;

      const tdEstado = document.createElement('td');
      tdEstado.appendChild(createTag(estado));

      const tdMsg = document.createElement('td');
      tdMsg.classList.add('col-msg');
      tdMsg.textContent = mensaje || '';

      const tdId = document.createElement('td');
      tdId.textContent = idFactura || '';

      const tdHora = document.createElement('td');
      tdHora.textContent = hora || formatTime();

      tr.appendChild(tdAdm);
      tr.appendChild(tdAccion);
      tr.appendChild(tdEstado);
      tr.appendChild(tdMsg);
      tr.appendChild(tdId);
      tr.appendChild(tdHora);

      tblBody.appendChild(tr);
    }

    function setRunningState(running) {
      isRunning = running;
      btnStart.disabled = running;
      btnStop.disabled = !running;
      btnClear.disabled = running;
      admisionesInput.disabled = running;
      institucionIdInput.disabled = running;
      chkFactura.disabled = running;
      chkFecha.disabled = running;
      chkEnviar.disabled = running;
      fechaEmisionInput.disabled = running || !chkFecha.checked;

      if (!running && processedItems === totalItems) {
        setStatus('idle', 'Proceso finalizado');
      }
    }

    // ==========================
    // üåê LLAMADAS A LA API
    // ==========================

    async function apiBuscarIdFactura(admision) {
      const body = { sSearch: String(admision).trim() };
      const resp = await fetch(`${API_BASE}/BuscarIdFactura`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (!resp.ok) {
        throw new Error(`Error HTTP ${resp.status} en BuscarIdFactura`);
      }

      const data = await resp.json();
      if (!data.idFactura) {
        throw new Error('No se encontr√≥ idFactura en la respuesta.');
      }

      return data; // {idFactura, numeroAdmision?}
    }

    async function apiGenerarNumeroFactura(idFactura) {
      const url = `${API_BASE}/GenerarNumeroFactura?idFacturas=${encodeURIComponent(idFactura)}`;
      const resp = await fetch(url);
      if (!resp.ok) {
        throw new Error(`Error HTTP ${resp.status} en GenerarNumeroFactura`);
      }
      return resp.json();
    }

    async function apiCambiarFecha(idFactura, fechaEmisionStr) {
      const body = {
        idFactura: String(idFactura),
        fechaEmision: fechaEmisionStr
      };
      const resp = await fetch(`${API_BASE}/cambiar-fecha`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (!resp.ok) {
        throw new Error(`Error HTTP ${resp.status} en cambiar-fecha`);
      }
      return resp.json();
    }

    async function apiEnviarDian(idFactura) {
      const body = { idFacturas: String(idFactura) };
      const resp = await fetch(`${API_BASE}/EnviarDian`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (!resp.ok) {
        throw new Error(`Error HTTP ${resp.status} en EnviarDian`);
      }
      return resp.json();
    }

    // ==========================
    // üîÅ PROCESAMIENTO
    // ==========================

    async function procesarAdmision(admision, fechaApiStr) {
      const admisionLabel = String(admision).trim() || '(vac√≠o)';

      // 1. Buscar factura por admisi√≥n
      let idFactura = null;
      try {
        const data = await apiBuscarIdFactura(admision);
        idFactura = data.idFactura;
        const numeroAdmision = data.numeroAdmision || admisionLabel;

        logRow({
          admision: numeroAdmision,
          accion: 'Buscar factura',
          estado: 'OK',
          mensaje: `Factura encontrada. idFactura = ${idFactura}`,
          idFactura
        });
      } catch (error) {
        logRow({
          admision: admisionLabel,
          accion: 'Buscar factura',
          estado: 'ERROR',
          mensaje: error.message || 'Error al buscar factura.',
          idFactura: ''
        });
        // Sin idFactura no se puede seguir
        return;
      }

      // 2. Generar n√∫mero de factura (si est√° marcado)
      if (chkFactura.checked) {
        try {
          const data = await apiGenerarNumeroFactura(idFactura);
          const numeroFactura = data.numeroFactura ?? '(sin n√∫mero)';
          const descripcion = data.mensajeRetorno || 'N√∫mero de factura generado.';

          logRow({
            admision: admisionLabel,
            accion: 'Generar n√∫mero',
            estado: 'OK',
            mensaje: `${descripcion} N√∫mero: ${numeroFactura}`,
            idFactura
          });
        } catch (error) {
          logRow({
            admision: admisionLabel,
            accion: 'Generar n√∫mero',
            estado: 'ERROR',
            mensaje: error.message || 'Error al generar n√∫mero de factura.',
            idFactura
          });
        }
      }

      // 3. Cambiar fecha de emisi√≥n (si est√° marcado)
      if (chkFecha.checked && fechaApiStr) {
        try {
          const data = await apiCambiarFecha(idFactura, fechaApiStr);
          const ok = data.ok;
          const msg = (data.data && data.data.mensajeRetorno) || 'Fecha de emisi√≥n actualizada.';
          const status = ok ? 'OK' : 'WARN';

          logRow({
            admision: admisionLabel,
            accion: 'Cambiar fecha',
            estado: status,
            mensaje: `${msg} (${fechaApiStr})`,
            idFactura
          });
        } catch (error) {
          logRow({
            admision: admisionLabel,
            accion: 'Cambiar fecha',
            estado: 'ERROR',
            mensaje: error.message || 'Error al cambiar fecha.',
            idFactura
          });
        }
      }

      // 4. Enviar a DIAN (si est√° marcado)
      if (chkEnviar.checked) {
        try {
          const data = await apiEnviarDian(idFactura);
          const msg =
            data.mensajeRetorno ||
            data.mensaje ||
            'Factura enviada a la DIAN (revisar respuesta del backend).';

          logRow({
            admision: admisionLabel,
            accion: 'Enviar DIAN',
            estado: 'OK',
            mensaje: msg,
            idFactura
          });
        } catch (error) {
          logRow({
            admision: admisionLabel,
            accion: 'Enviar DIAN',
            estado: 'ERROR',
            mensaje: error.message || 'Error al enviar a la DIAN.',
            idFactura
          });
        }
      }
    }

    async function procesarLote() {
      const rawText = admisionesInput.value || '';
      const l√≠neas = rawText.split(/\r?\n/).map(s => s.trim()).filter(Boolean);

      if (!l√≠neas.length) {
        alert('Por favor ingresa al menos un n√∫mero de admisi√≥n.');
        return;
      }

      if (!chkFactura.checked && !chkFecha.checked && !chkEnviar.checked) {
        const continuar = confirm(
          'No has seleccionado ninguna acci√≥n (solo se buscar√° la factura). ¬øDeseas continuar?'
        );
        if (!continuar) return;
      }

      if (chkFecha.checked) {
        if (!fechaEmisionInput.value) {
          alert('Selecciona una fecha de emisi√≥n para poder cambiar la fecha.');
          return;
        }
      }

      totalItems = l√≠neas.length;
      processedItems = 0;
      updateProgress(0, totalItems);
      setRunningState(true);
      setStatus('running', 'Procesando admisiones...');

      const fechaApiStr = chkFecha.checked ? formatDateForApi(fechaEmisionInput.value) : null;

      for (let i = 0; i < l√≠neas.length; i++) {
        if (!isRunning) {
          setStatus('stopped', 'Proceso detenido por el usuario');
          break;
        }

        const admision = l√≠neas[i];
        await procesarAdmision(admision, fechaApiStr);
        updateProgress(i + 1, totalItems);
      }

      setRunningState(false);
    }

    // ==========================
    // üéõÔ∏è EVENTOS UI
    // ==========================

    // chips visualmente activas
    function syncChip(label, input) {
      if (input.checked) {
        label.classList.add('chip-active');
      } else {
        label.classList.remove('chip-active');
      }
    }

    document.querySelectorAll('.chip').forEach(chip => {
      const input = chip.querySelector('input');
      syncChip(chip, input);
      input.addEventListener('change', () => {
        syncChip(chip, input);
        if (input === chkFecha) {
          fechaEmisionInput.disabled = !chkFecha.checked || isRunning;
        }
      });
    });

    btnStart.addEventListener('click', () => {
      procesarLote().catch(err => {
        console.error(err);
        alert('Ocurri√≥ un error inesperado al procesar el lote.');
        setRunningState(false);
      });
    });

    btnStop.addEventListener('click', () => {
      if (isRunning) {
        isRunning = false; // el loop se detendr√° una vez termine la admisi√≥n actual
        setStatus('stopped', 'Deteniendo despu√©s de la admisi√≥n actual...');
      }
    });

    btnClear.addEventListener('click', () => {
      admisionesInput.value = '';
      tblBody.innerHTML = '';
      bar.style.width = '0%';
      totalItems = 0;
      processedItems = 0;
      lblProcessed.textContent = '0';
      lblTotal.textContent = '/ 0 procesadas';
      setStatus('idle', 'En espera');
    });

    // ==========================
    // üöÄ INICIALIZACI√ìN
    // ==========================
    document.addEventListener('DOMContentLoaded', () => {
      fechaEmisionInput.value = todayAsInputValue();
      fechaEmisionInput.disabled = !chkFecha.checked;
      setStatus('idle', 'En espera');
      lblProcessed.textContent = '0';
      lblTotal.textContent = '/ 0 procesadas';
    });
  </script>
</body>
</html>
