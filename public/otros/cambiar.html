<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Generar factura / Cambiar fecha / Enviar a la DIAN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1020;
      --panel:#121a35;
      --panel-2:#0f1530;
      --text:#e6ebff;
      --muted:#9fb0ff;
      --accent:#5b8cff;
      --accent-2:#7aa2ff;
      --ok:#2ecc71;
      --warn:#f1c40f;
      --err:#e74c3c;
      --border:rgba(255,255,255,.08);
      --chip:#1b244a;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#070b18);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;}
    .shell{max-width:1040px;margin:32px auto;padding:0 16px}
    .title{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .title h1{font-size:22px;margin:0}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .hd{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .card .bd{padding:18px 20px}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(12,1fr)}
    .grid .col-3{grid-column:span 3}
    .grid .col-4{grid-column:span 4}
    .grid .col-6{grid-column:span 6}
    .grid .col-8{grid-column:span 8}
    .grid .col-12{grid-column:span 12}
    @media(max-width:900px){.grid .col-3,.grid .col-4,.grid .col-6,.grid .col-8{grid-column:span 12}}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,textarea{width:100%;padding:12px;background:#0e1430;color:var(--text);border:1px solid var(--border);border-radius:12px}
    textarea{min-height:160px;resize:vertical}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:0;color:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600;box-shadow:var(--shadow)}
    .btn.secondary{background:#1d274d}
    .btn.ghost{background:transparent;border:1px solid var(--border)}
    .progress{width:100%;height:10px;background:#0b1330;border-radius:999px;overflow:hidden;border:1px solid var(--border)}
    .progress>div{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .25s}
    table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-top:10px}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:14px;text-align:left}
    th{background:#0f1733;color:#cdd9ff}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px}
    .pill.ok{background:rgba(46,204,113,.1);color:var(--ok)}
    .pill.err{background:rgba(231,76,60,.1);color:var(--err)}
    .pill.run{background:rgba(241,196,15,.1);color:var(--warn)}
    .kbd{font-family:monospace;background:#0f1733;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    .muted{color:var(--muted)}
    .chips{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{display:flex;gap:8px;align-items:center;background:#0f1733;border:1px solid var(--border);padding:8px 10px;border-radius:12px}
    .chip input{width:auto;accent-color:#7aa2ff}
    .hint{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="shell">
    <div class="title">
      <h1>üßæ Generar n√∫mero / Cambiar fecha / Enviar a DIAN</h1>
    </div>
    <div class="card">
      <div class="hd">
        <span class="muted">Automatiza acciones por n√∫mero de admisi√≥n</span>
        <button id="btnClear" class="btn ghost">Limpiar</button>
      </div>
      <div class="bd">
        <div class="grid">
          <div class="col-3">
            <label>Instituci√≥n ID</label>
            <input id="institucionId" type="number" min="1" value="20" />
          </div>
          <div class="col-6">
            <label>Qu√© deseas hacer</label>
            <div class="chips" role="group" aria-label="Opciones de proceso">
              <label class="chip"><input id="chkFactura" type="checkbox" checked> Generar n√∫mero de factura</label>
              <label class="chip"><input id="chkFecha" type="checkbox"> Cambiar fecha de emisi√≥n</label>
              <label class="chip"><input id="chkEnviar" type="checkbox"> Enviar a la DIAN</label>
            </div>
            <div class="hint">Si marcas todo, el orden ser√°: <b>Generar n√∫mero ‚Üí Cambiar fecha ‚Üí Enviar a DIAN</b>. Cada acci√≥n es independiente.</div>
          </div>
          <div class="col-3">
            <label>Fecha de emisi√≥n</label>
            <input id="fechaEmision" type="date" disabled />
          </div>

          <div class="col-12">
            <label>N√∫meros de admisi√≥n (uno por l√≠nea)</label>
            <textarea id="admisiones" placeholder="142811\n144140\n..."></textarea>
          </div>

          <div class="col-12" style="display:flex;gap:10px;align-items:center">
            <button id="btnStart" class="btn">Iniciar</button>
            <button id="btnStop" class="btn secondary">Detener</button>
            <span class="muted">Procesa una por una y muestra resultados.</span>
          </div>
        </div>

        <div style="margin-top:18px;">
          <div class="progress"><div id="bar"></div></div>
        </div>

        <table id="tbl">
          <thead>
            <tr>
              <th>Admisi√≥n</th>
              <th>Acci√≥n</th>
              <th>Estado</th>
              <th>Mensaje</th>
              <th>ID Facturas</th>
              <th>Hora</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ==============================================
    // ‚öôÔ∏è CONFIGURACI√ìN (independiente, sin librer√≠as externas)
    // ==============================================
    const urlBase = 'https://total-oeyx.onrender.com';  // puedes cambiarlo por tu host
    const PATH_CAMBIAR_FECHA = '/cambiar-fecha';
    const PATH_POR_ADMISION  = '/por-admision';
    const PATH_ENVIAR_DIAN   = '/EnviarFacturaElectronica';
    const CONCURRENCY = 1;

    const el = (id)=>document.getElementById(id);
    const $tbl = el('tbl').querySelector('tbody');
    const $bar = el('bar');
    let STOP = false;

    const mmddyyyy = (v)=>{if(!v)return'';const [y,m,d]=v.split('-');return `${m}/${d}/${y}`};
    const now = ()=> new Date().toLocaleTimeString();
    const sanitize = t=>t.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

    const actionLabel = (key)=> {
      switch(key){
        case 'factura': return 'Generar factura';
        case 'fecha': return 'Cambiar fecha';
        case 'enviar': return 'Enviar a la DIAN';
        default: return key;
      }
    };

    const row = (adm, action)=>{
      const tr=document.createElement('tr');
      tr.dataset.adm=adm;
      tr.dataset.action=action;
      tr.innerHTML=`<td><span class="kbd">${adm}</span></td>
        <td>${actionLabel(action)}</td>
        <td><span class="pill run">Pendiente</span></td>
        <td class="muted">‚Äî</td><td class="muted">‚Äî</td><td class="muted">${now()}</td>`;
      return tr;
    };

    function setRow(adm, action, state, msg, ids){
      const tr=[...$tbl.querySelectorAll(`tr[data-adm="${adm}"]`)].find(r=>r.dataset.action===action);
      if(!tr)return;
      tr.children[2].innerHTML=
        state==='ok'?'<span class="pill ok">OK</span>':
        state==='err'?'<span class="pill err">Error</span>':
        '<span class="pill run">En proceso</span>';
      tr.children[3].textContent=msg||'';
      tr.children[4].textContent=Array.isArray(ids)?ids.join(', '):(ids||'‚Äî');
      tr.children[5].textContent=now();
    }

    // =============================
    // üì° Llamados al backend
    // =============================
    async function callCambiarFecha({institucionId,numeroAdmision,fechaEmision}){
      const url=urlBase+PATH_CAMBIAR_FECHA;
      const res=await fetch(url,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({institucionId,numeroAdmision,fechaEmision})
      });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function callGenerarFactura({institucionId,numeroAdmision}){
      const qs = new URLSearchParams({institucionId:String(institucionId),numeroAdmision:String(numeroAdmision)});
      const url = `${urlBase+PATH_POR_ADMISION}?${qs.toString()}`;
      const res = await fetch(url, { method:'GET', headers:{'Content-Type':'application/json'} });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function callEnviarDian({institucionId,numeroAdmision}){
      const qs = new URLSearchParams({institucionId:String(institucionId),numeroAdmision:String(numeroAdmision)});
      const url = `${urlBase+PATH_ENVIAR_DIAN}?${qs.toString()}`;
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'} });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    // =============================
    // ‚ñ∂Ô∏è Flujo principal
    // =============================
    async function run(){
      STOP=false;
      $tbl.innerHTML='';

      const list=sanitize(el('admisiones').value);
      const institucionId=Number(el('institucionId').value);
      const cambiarFecha=el('chkFecha').checked;
      const generarFactura=el('chkFactura').checked;
      const enviarDian=el('chkEnviar').checked;
      const fechaEmision=mmddyyyy(el('fechaEmision').value);

      if(!list.length) return alert('Agrega al menos un n√∫mero de admisi√≥n.');
      if(!cambiarFecha && !generarFactura && !enviarDian) return alert('Selecciona al menos una opci√≥n.');
      if(cambiarFecha && !fechaEmision) return alert('Selecciona la fecha de emisi√≥n.');
      // Nota: enviar a DIAN ya no depende del check de generar factura (puede existir ya creada)

      // Crear filas por cada acci√≥n seleccionada (orden: factura ‚Üí fecha ‚Üí enviar)
      const actions = [];
      for(const adm of list){
        if(generarFactura){ $tbl.appendChild(row(adm,'factura')); actions.push({adm, type:'factura'}); }
        if(cambiarFecha){ $tbl.appendChild(row(adm,'fecha')); actions.push({adm, type:'fecha'}); }
        if(enviarDian){ $tbl.appendChild(row(adm,'enviar')); actions.push({adm, type:'enviar'}); }
      }

      let done=0;const total=actions.length;

      const processOne = async (item)=>{
        const {adm, type} = item;
        try{
          setRow(adm,type,'run','Procesando...');
          if(type==='factura'){
            const r = await callGenerarFactura({institucionId,numeroAdmision:adm});
            const msg = r?.resultado_remoto?.mensajeRetorno || r?.mensaje || 'OK';
            const idTxt = r?.id_factura || r?.idFactura || r?.id || (r?.resultado_remoto?.numeroFactura ? `Factura: ${r.resultado_remoto.numeroFactura}` : '‚Äî');
            setRow(adm,'factura','ok',msg,idTxt);
          } else if(type==='fecha'){
            const r = await callCambiarFecha({institucionId,numeroAdmision:adm,fechaEmision});
            const msg = r?.mensaje || 'Fecha actualizada';
            const ids = r?.idFacturas || r?.ids || '‚Äî';
            setRow(adm,'fecha','ok',msg,ids);
          } else if(type==='enviar'){
            const r = await callEnviarDian({institucionId,numeroAdmision:adm});
            const data = r?.data || r;
            const isOk = Number(data?.valorRetorno) === 1 || r?.ok === true;
            const msg = (data?.mensajeRetorno && String(data.mensajeRetorno).trim()) || (isOk ? 'Enviada a DIAN' : 'Sin mensaje');
            const idTxt = data?.numeroFactura || data?.idFactura || '‚Äî';
            setRow(adm,'enviar', isOk ? 'ok' : 'err', msg, idTxt);
          }
        }catch(e){
          setRow(item.adm,item.type,'err',e.message);
        }
      };

      const next = async ()=>{
        if(STOP) return; 
        const item = actions[done];
        if(!item) return; 
        await processOne(item);
        done++; 
        $bar.style.width=`${Math.round((done/total)*100)}%`;
        if(done<total && !STOP) next();
      };

      next();
    }

    // =============================
    // üîò Eventos de UI
    // =============================
    el('btnStart').onclick=run;
    el('btnStop').onclick=()=>STOP=true;
    el('btnClear').onclick=()=>{$tbl.innerHTML='';$bar.style.width='0%';};

    // Habilitar/deshabilitar fecha seg√∫n el check
    const $chkFecha = el('chkFecha');
    const $fecha    = el('fechaEmision');
    const toggleFechaInput = ()=>{ $fecha.disabled = !$chkFecha.checked; if(!$chkFecha.checked){ $fecha.value=''; } };
    $chkFecha.addEventListener('change', toggleFechaInput);
    toggleFechaInput();
  </script>
</body>
</html>